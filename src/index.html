<!doctype html>
<title>Map Gallery</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="node_modules/dialog-polyfill/dist/dialog-polyfill.css">
<style>
  #map { display: flex; }

  #map svg {
    height: calc(100vh - 16px);
    width: calc(100vw - 16px);
  }

  #map svg path:hover {
    stroke-width: 3;
    stroke: red;
  }

  dialog img {
    max-width: calc(100vw - 3*16px);
    max-height: calc(100vh - 4*16px - 2rem);
  }

  @media (min-width: 601px) {
    footer {
      width: 600px;
      margin: 0 auto;
    }
  }

  footer { margin-top: 1em; }
</style>

<div id="map"></div>
<footer>
  Lorem ipsum dolor sit amet, consectetuer adipiscing elit.  Donec
  hendrerit tempor tellus.  Donec pretium posuere tellus.  Proin quam
  nisl, tincidunt et, mattis eget, convallis nec, purus.  Cum sociis
  natoque penatibus et magnis dis parturient montes, nascetur
  ridiculus mus.  Nulla posuere.  Donec vitae dolor.  Nullam tristique
  diam non turpis.  Cras placerat accumsan nulla.  Nullam rutrum.  Nam
  vestibulum accumsan nisl.
</footer>

<dialog id="popup">
  <header style="margin-bottom: 1em">
    <button id="popup__close">Close</button>
    <button id="popup__twitter">Open Twitter account</button>
  </header>
  <div><img id="popup__photo"></div>
</dialog>

<script type="module">
  class Popup {
      constructor() {
          this.dlg = document.querySelector('#popup')
          dialogPolyfill.registerDialog(this.dlg)

          let close = document.querySelector('#popup__close')
          close.onclick = () => this.close()

          let twitter = document.querySelector('#popup__twitter')
          twitter.onclick = () => {
              this.close()
              let account = this.dlg.querySelector('img').src.split('/')
                  .slice(-1)?.[0].replace(/\.[^.]+$/, '')
              window.open(`https://twitter.com/${account}`, '_blank')
          }
      }
      update(file_url) { this.dlg.querySelector('img').src = file_url }
      open() { this.dlg.showModal() }
      close() { this.dlg.close() }
  }

  class Mapa {
      constructor() { this.popup = new Popup() }

      fetch() {
          fetch('map.json').then( r => r.json()).then( v => this.data = v)
      }

      photo(id) {
          return (node) => {
              let img = this.data?.[id]; if (!img) return
              console.log(id, img)
              this.popup.update(img.file)
              this.popup.open()
          }
      }

      draw(node) {
          let img = this.data?.[node.id]; if (!img) return
          let svg = `<svg width="0" height="0" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <pattern id="img_${node.id}" height="1" width="1" >
      <image href="${img.file}" x="${img.x || 0}" y="${img.y || 0}" height="${img.height || 100}" width="${img.width || 100}" />
    </pattern>
  </defs>
</svg>`
          let el = document.createElement('div')
          document.body.appendChild(el)
          el.innerHTML = svg
          node.style.fill = `url(#img_${node.id})`
      }
  }

  function svg_title_add(node) {
      let t = document.createElementNS('http://www.w3.org/2000/svg', 'title')
      t.innerHTML = node.id
      node.appendChild(t)
  }

  let mapa = new Mapa()
  await mapa.fetch()
  await fetch('map.svg').then( r => r.text()).then( v => {
      document.querySelector('#map').innerHTML = v
  })

  document.querySelectorAll('svg path').forEach( node => {
      node.onclick = mapa.photo(node.id)
      mapa.draw(node)
      svg_title_add(node)
  })
</script>

<script src="node_modules/dialog-polyfill/dist/dialog-polyfill.js"></script>
